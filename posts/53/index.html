<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API cache</title>
    <meta name="description" content="Exercises on Vanilla JS Academy 2020">
    <link rel="stylesheet" href="/vanillajsacademy/css/index.css">
    <link rel="stylesheet" href="/vanillajsacademy/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/vanillajsacademy/feed/feed.xml" type="application/atom+xml" title="miguelslp - Vanilla JS">
    <link rel="alternate" href="/vanillajsacademy/feed/feed.json" type="application/json" title="miguelslp - Vanilla JS">
  </head>
  <body>
    <header>
      <h1 class="home">
        <a href="/vanillajsacademy/">miguelslp - Vanilla JS</a>
      </h1>
      
    </header>

    <main  class="tmpl-post" >
      <h1>API cache</h1>

<div class="grid">
<style>

</style>
<!-- Setting the html code -->

<!-- Setting the js code -->


<!-- Rendering the html -->
<div class="htmlBox">
  
<div id="app">
  Loading...
</div>

</div>

<!-- Rendering the html and js as syntax highlight -->
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  Loading...<br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br> <br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token comment">// get the app element</span><br>  <span class="token keyword">var</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// define a localStorage id</span><br>  <span class="token keyword">var</span> storageID <span class="token operator">=</span> <span class="token string">'pirateCache'</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// sanitize html from API</span><br>  <span class="token keyword">var</span> <span class="token function-variable function">sanitizeHTML</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">var</span> temp <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    temp<span class="token punctuation">.</span>textContent <span class="token operator">=</span> str<span class="token punctuation">;</span><br>    <span class="token keyword">return</span> temp<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// get articles from the cache if still valid, or from the API if not</span><br>  <span class="token keyword">var</span> <span class="token function-variable function">fetchArticles</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">// check for valid cached data</span><br>    <span class="token comment">// if it exists, use it</span><br>    <span class="token keyword">var</span> saved <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>saved<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">renderNews</span><span class="token punctuation">(</span>saved<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'loaded from cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// fetch articles from the API</span><br>    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://vanillajsacademy.com/api/pirates.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">renderNews</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token function">saveData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fetched from API'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">renderNoArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// render articles into the ui</span><br>  <span class="token keyword">var</span> <span class="token function-variable function">renderNews</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">// if there are no articles, render a message into the UI</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>articles<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">renderNoArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">return</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// otherwise, render the UI</span><br>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data<span class="token punctuation">.</span>articles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">article</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>      <span class="token comment">// create html</span><br>      <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token string">'&lt;article>'</span> <span class="token operator">+</span><br>        <span class="token string">'&lt;h2>'</span> <span class="token operator">+</span> <span class="token function">sanitizeHTML</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/h2>'</span> <span class="token operator">+</span><br>        <span class="token string">'&lt;p>&lt;em>By '</span> <span class="token operator">+</span> <span class="token function">sanitizeHTML</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>author<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' on '</span> <span class="token operator">+</span> <span class="token function">sanitizeHTML</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>pubdate<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/em>&lt;/p>'</span> <span class="token operator">+</span><br>        <span class="token function">sanitizeHTML</span><span class="token punctuation">(</span>article<span class="token punctuation">.</span>article<span class="token punctuation">)</span> <span class="token operator">+</span><br>        <span class="token string">'&lt;/article>'</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">return</span> html<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;p>&lt;em>Articles from &lt;a href="'</span> <span class="token operator">+</span> <span class="token function">sanitizeHTML</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>attribution<span class="token punctuation">.</span>url<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'">'</span> <span class="token operator">+</span> <span class="token function">sanitizeHTML</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>attribution<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/a>&lt;/em>&lt;/p>'</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// render a message when there are no articles to share</span><br>  <span class="token keyword">var</span> <span class="token function-variable function">renderNoArticles</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;p>There be no pirate news afoot, matey. Check back later.&lt;/p>'</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// save article data to localStorage</span><br>  <span class="token keyword">var</span> <span class="token function-variable function">saveData</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">// create a cache object with a timestamp</span><br>    <span class="token keyword">var</span> cache <span class="token operator">=</span> <span class="token punctuation">{</span><br>      data<span class="token operator">:</span> data<span class="token punctuation">,</span><br>      timestamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// stringify it and save it to localstorage</span><br>    localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>storageID<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// get API data from localStorage</span><br>  <span class="token keyword">var</span> <span class="token function-variable function">getData</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">// get saved daa from localStorage</span><br>    <span class="token keyword">var</span> saved <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>storageID<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>saved<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br>    saved <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>saved<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// if data  has not expired, return it</span><br>    <span class="token comment">// use cached data from 30 seconds</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDataValid</span><span class="token punctuation">(</span>saved<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> saved<span class="token punctuation">.</span>data<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// check if the data is valid</span><br>  <span class="token keyword">var</span> <span class="token function-variable function">isDataValid</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">saved<span class="token punctuation">,</span> goodFor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token comment">// check that there is data, and a timestamp key</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>saved <span class="token operator">||</span> <span class="token operator">!</span>saved<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token operator">!</span>saved<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// get the difference between the timestamp and current time</span><br>    <span class="token keyword">var</span> difference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> saved<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> difference <span class="token operator">&lt;</span> goodFor<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br><br>  <span class="token function">fetchArticles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>

<!-- Inserting the js as a script -->

<script>
  // get the app element
  var app = document.querySelector('#app');

  // define a localStorage id
  var storageID = 'pirateCache';

  // sanitize html from API
  var sanitizeHTML = function (str) {
    var temp = document.createElement('div');
    temp.textContent = str;
    return temp.innerHTML;
  };

  // get articles from the cache if still valid, or from the API if not
  var fetchArticles = function () {

    // check for valid cached data
    // if it exists, use it
    var saved = getData();
    if (saved) {
      renderNews(saved);
      console.log('loaded from cache');
      return;
    }

    // fetch articles from the API
    fetch('https://vanillajsacademy.com/api/pirates.json').then(function (response) {
      if (response.ok) {
        return response.json();
      } else {
        return Promise.reject(response);
      }
    }).then(function (data) {
      renderNews(data);
      saveData(data);
      console.log('fetched from API');
    }).catch(function () {
      renderNoArticles();
    });
  };

  // render articles into the ui
  var renderNews = function (data) {

    // if there are no articles, render a message into the UI
    if (data.articles.length < 1) {
      renderNoArticles();
      return;
    }

    // otherwise, render the UI
    app.innerHTML = data.articles.map(function (article) {

      // create html
      var html = '<article>' +
        '<h2>' + sanitizeHTML(article.title) + '</h2>' +
        '<p><em>By ' + sanitizeHTML(article.author) + ' on ' + sanitizeHTML(article.pubdate) + '</em></p>' +
        sanitizeHTML(article.article) +
        '</article>';

      return html;
    }).join('') + '<p><em>Articles from <a href="' + sanitizeHTML(data.attribution.url) + '">' + sanitizeHTML(data.attribution.name) + '</a></em></p>';
  };

  // render a message when there are no articles to share
  var renderNoArticles = function () {
    app.innerHTML = '<p>There be no pirate news afoot, matey. Check back later.</p>';
  };

  // save article data to localStorage
  var saveData = function (data) {

    // create a cache object with a timestamp
    var cache = {
      data: data,
      timestamp: new Date().getTime()
    };

    // stringify it and save it to localstorage
    localStorage.setItem(storageID, JSON.stringify(cache));
  };

  // get API data from localStorage
  var getData = function () {

    // get saved daa from localStorage
    var saved = localStorage.getItem(storageID);
    if (!saved) return;
    saved = JSON.parse(saved);

    // if data  has not expired, return it
    // use cached data from 30 seconds
    if (isDataValid(saved, 1000 * 30)) {
      return saved.data;
    }
  }

  // check if the data is valid
  var isDataValid = function (saved, goodFor) {

    // check that there is data, and a timestamp key
    if (!saved || !saved.data || !saved.timestamp) return false;

    // get the difference between the timestamp and current time
    var difference = new Date().getTime() - saved.timestamp;

    return difference < goodFor;
  }


  fetchArticles();
</script>

</div>

    </main>

    <footer>
      ©
      Miguel Pinto
      2021
    </footer>

    <!-- Current page: /vanillajsacademy/posts/53/ -->

    
    
  </body>
</html>